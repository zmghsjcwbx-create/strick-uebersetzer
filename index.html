<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Kerstins Strickübersetzer – DE · EN · FR</title>

  <!-- Favicon: Datei favicon.png ins Repo legen -->
  <link rel="icon" type="image/png" href="favicon.png">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --accent: #3662ff;
      --accent-soft: #e2e8ff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --danger: #b91c1c;
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --table-head-bg: #eff1ff;
      --quote-bg: #eef2ff;
      --quote-border: #d1d5ff;
      --output-bg: #f9fafb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text-main);
      font-size: 100%;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 60px 14px 36px;
      position: relative;
    }

    header {
      margin-bottom: 20px;
    }

    h1 {
      margin: 0;
      font-size: 1.9rem;
      text-align: center;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .subtitle {
      margin-top: 6px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 18px 18px 20px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      margin-bottom: 18px;
      transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
      color: var(--text-muted);
    }

    textarea {
      width: 100%;
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      font-family: Menlo, "SF Mono", Consolas, monospace;
      font-size: 0.95rem;
      resize: vertical;
      min-height: 110px;
      background: #ffffff;
      color: var(--text-main);
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    textarea::placeholder {
      color: #9ca3af;
    }

    textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
      justify-content: space-between;
    }

    button {
      background: var(--accent);
      color: #ffffff;
      border: none;
      border-radius: 999px;
      padding: 9px 24px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s ease, transform 0.05s ease, box-shadow 0.1s ease;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
    }

    button:hover {
      background: #2746c9;
      box-shadow: 0 5px 14px rgba(37, 99, 235, 0.45);
    }

    button:active {
      transform: scale(0.98);
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
    }

    .btn-example {
      background: #10b981;
      box-shadow: 0 4px 10px rgba(16, 185, 129, 0.35);
    }

    .btn-example:hover {
      background: #059669;
      box-shadow: 0 5px 14px rgba(16, 185, 129, 0.45);
    }

    .controls-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      align-items: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    select {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 0.85rem;
    }

    .checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .hint {
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .output {
      margin-top: 14px;
      border-radius: 16px;
      border: 2px solid var(--accent);
      background: var(--output-bg);
      padding: 14px 14px 16px;
      min-height: 52px;
      font-size: 1.05rem;
      line-height: 1.6;
      font-weight: 500;
      transition: background 0.2s ease, border-color 0.2s ease;
    }

    .warning {
      color: var(--danger);
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      margin: 6px 0 4px;
    }

    .secondary-row {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .secondary-label {
      font-weight: 600;
      margin-right: 4px;
    }

    h2 {
      font-size: 1rem;
      margin: 0 0 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      border: 1px solid var(--border);
      padding: 4px 6px;
      vertical-align: top;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    th {
      background: var(--table-head-bg);
      font-weight: 600;
    }

    .top-bar-toggles {
      position: fixed;
      right: 14px;
      top: 8px;
      z-index: 20;
      display: flex;
      gap: 10px;
      font-size: 0.8rem;
      color: var(--text-muted);
      align-items: center;
      background: rgba(255,255,255,0.85);
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(148,163,184,0.4);
      backdrop-filter: blur(10px);
    }

    .top-toggle-label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .font-buttons-wrapper {
      display: none;
    }

    .quote-box {
      margin-top: 16px;
      padding: 14px 16px;
      border-radius: 14px;
      background: var(--quote-bg);
      border: 1px solid var(--quote-border);
      font-size: 0.98rem;
      color: var(--text-main);
    }

    .quote-text {
      font-style: italic;
      font-size: 1.02rem;
    }

    .quote-author {
      margin-top: 6px;
      font-weight: 600;
    }

    .quote-source {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .history-list {
      list-style: none;
      padding-left: 0;
      margin: 6px 0 0;
      font-size: 0.85rem;
    }

    .history-item {
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      color: #2563eb;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-item span {
      color: var(--text-muted);
      margin-right: 4px;
      font-size: 0.8rem;
    }

    .history-empty {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 0;
    }

    .table-toggle {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      color: #2563eb;
    }

    .table-toggle-icon {
      font-size: 0.9rem;
    }

    .hidden {
      display: none;
    }

    .session-id-display {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 6px;
      padding: 4px 6px;
      background: rgba(0,0,0,0.03);
      border-radius: 4px;
      font-family: monospace;
      word-break: break-all;
    }

    @media (max-width: 640px) {
      .card {
        padding: 16px 14px 18px;
        border-radius: 14px;
      }
      h1 {
        font-size: 1.6rem;
      }
      .top-row {
        flex-direction: column;
        align-items: flex-start;
      }
      button {
        width: 100%;
        text-align: center;
      }
      .page {
        padding-top: 72px;
      }
      .top-bar-toggles {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
      }
    }
  </style>
</head>
<body>
<div class="top-bar-toggles">
  <label class="top-toggle-label">
    <input type="checkbox" id="darkToggle">
    Dark&nbsp;Mode
  </label>
  <div class="top-toggle-label font-buttons-wrapper">
    Schrift:
    <div class="font-buttons">
      <button type="button" class="font-btn active" data-size="normal">Normal</button>
      <button type="button" class="font-btn" data-size="large">Groß</button>
      <button type="button" class="font-btn" data-size="xlarge">Sehr groß</button>
    </div>
  </div>
</div>

<div class="page">
  <header>
    <h1>Dein Strick-Übersetzer</h1>
    <p class="subtitle">Deutsch · Englisch · Französisch – klar und übersichtlich, auch für Handy & Tablet.</p>
  </header>

  <div class="card">
    <label for="input">Eingabe</label>
    <textarea id="input"
      placeholder="Schreibe hier deine Strickanweisung, z.B.:  Umschlag, 2 re zus., 3 li, 4 re"></textarea>

    <div class="top-row">
      <div>
        <button id="btn">Übersetzen</button>
        <button id="btnExample" class="btn-example">Zufälliges Beispiel</button>
      </div>

      <div class="controls-inline">
        <div>
          Hauptausgabe:
          <select id="mainLang">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
            <option value="fr">Français</option>
          </select>
        </div>

        <label class="checkbox-label">
          <input type="checkbox" id="showOthers" checked>
          Andere Sprachen kurz anzeigen
        </label>
      </div>
    </div>

    <p class="hint">
      Die Hauptsprache zeigt zuerst alle Kurzformen (Abkürzungen), danach die Langformen – jeweils kommagetrennt.
    </p>

    <div id="output" class="output"></div>
    <div id="quote" class="quote-container"></div>
  </div>

  <div class="card">
    <h2 style="margin-bottom:4px;">Verlauf der letzten Eingaben</h2>
    <p class="hint" style="margin-top:0;">Klicke auf eine Zeile, um die Eingabe erneut zu laden.</p>
    <ul id="history" class="history-list"></ul>
  </div>

  <div class="card">
    <div class="table-toggle" id="tableToggle">
      <span class="table-toggle-icon" id="tableToggleIcon">▶</span>
      <span>Begriffstabelle anzeigen / ausblenden</span>
    </div>

    <div id="tableContainer" class="hidden">
      <h2>Übersicht: Begriffe Deutsch / Englisch / Französisch</h2>
      <table>
        <tr><th>Deutsch</th><th>Englisch (US/UK)</th><th>Französisch</th><th>Hinweis</th></tr>
        <tr><td>rechte Masche (re)</td><td>knit (k)</td><td>maille endroit (m.end.)</td><td>Grundmasche rechts</td></tr>
        <tr><td>linke Masche (li)</td><td>purl (p)</td><td>maille envers (m.env.)</td><td>Grundmasche links</td></tr>
        <tr><td>Umschlag (U)</td><td>yarn over (yo)</td><td>jeté</td><td>Loch / Zunahme über Fadenumschlag</td></tr>
        <tr><td>2 zus. re</td><td>k2tog</td><td>2 m. end. ens.</td><td>2 Maschen rechts zusammenstricken</td></tr>
        <tr><td>2 zus. li</td><td>p2tog</td><td>2 m. env. ens.</td><td>2 Maschen links zusammenstricken</td></tr>
        <tr><td>Überzug re</td><td>ssk</td><td>surjet simple</td><td>schräge Abnahme nach links</td></tr>
        <tr><td>Anschlag</td><td>cast on (CO)</td><td>monter</td><td>Maschen neu anschlagen</td></tr>
        <tr><td>Abketten</td><td>bind off (BO)</td><td>rabattre</td><td>Maschen elastisch beenden</td></tr>
        <tr><td>bis Ende</td><td>to end</td><td>jusqu'à la fin</td><td>bis zum Reihenende fortsetzen</td></tr>
        <tr><td>Rippenmuster 1x1</td><td>1x1 rib</td><td>côtes 1x1</td><td>abwechselnd 1 re, 1 li</td></tr>
        <tr><td>Rippenmuster 2x2</td><td>2x2 rib</td><td>côtes 2x2</td><td>2 re, 2 li im Wechsel</td></tr>
        <tr><td>kraus rechts</td><td>garter stitch</td><td>point mousse</td><td>in allen Reihen rechts</td></tr>
        <tr><td>glatt rechts</td><td>stocking stitch</td><td>jersey endroit</td><td>Vorderseite rechts, Rückseite links</td></tr>
        <tr><td>Perlmuster</td><td>moss stitch</td><td>point de riz</td><td>abwechselnd re/li, versetzt in der Höhe</td></tr>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Tech‑Support</h2>
    <p style="margin-top:4px;font-size:0.9rem;color:#6b7280;">
      Brauchst du Hilfe?
      <a id="techSupportLink"
         style="color:#2563eb;text-decoration:none;">
        Tech‑Support per Nachricht öffnen
      </a>
    </p>
    <div id="sessionInfo" class="session-id-display" style="display:none;"></div>
  </div>
</div>

<script>
// Beispiel-Wörterbuch
const dict = [
  { deShort: "re", deLong: "rechte Masche",
    enShort: "k",  enLong: "knit",
    frShort: "m.end.", frLong: "maille endroit" },

  { deShort: "li", deLong: "linke Masche",
    enShort: "p",  enLong: "purl",
    frShort: "m.env.", frLong: "maille envers" },

  { deShort: "umschlag", deLong: "Umschlag",
    enShort: "yo",       enLong: "yarn over",
    frShort: "jeté",     frLong: "jeté" },

  { deShort: "2 zus. re", deLong: "2 zusammen rechts",
    enShort: "k2tog",     enLong: "knit 2 together",
    frShort: "2 m. end. ens.", frLong: "2 mailles ensemble à l'endroit" },

  { deShort: "2 zus. li", deLong: "2 zusammen links",
    enShort: "p2tog",     enLong: "purl 2 together",
    frShort: "2 m. env. ens.", frLong: "2 mailles ensemble à l'envers" },

  { deShort: "überzug re", deLong: "Überzug rechts",
    enShort: "ssk",       enLong: "slip, slip, knit",
    frShort: "surjet",    frLong: "surjet simple à l'endroit" },

  { deShort: "anschlag",  deLong: "Maschen anschlagen",
    enShort: "CO",        enLong: "cast on",
    frShort: "monter",    frLong: "monter les mailles" },

  { deShort: "abketten",  deLong: "Maschen abketten",
    enShort: "BO",        enLong: "bind off",
    frShort: "rabattre",  frLong: "rabattre les mailles" },

  { deShort: "bis ende",  deLong: "bis Reihenende",
    enShort: "to end",    enLong: "to the end of row",
    frShort: "jusqu'à la fin", frLong: "jusqu'à la fin du rang" },

  { deShort: "rippen 1x1", deLong: "Rippenmuster 1x1",
    enShort: "1x1 rib",   enLong: "1x1 rib",
    frShort: "côtes 1x1", frLong: "côtes 1x1" },

  { deShort: "rippen 2x2", deLong: "Rippenmuster 2x2",
    enShort: "2x2 rib",   enLong: "2x2 rib",
    frShort: "côtes 2x2", frLong: "côtes 2x2" }
];

// Beispiele (nur EN + FR)
const examples = {
  en: [
    "yo, k2tog, p2, to end",
    "cast on 20, 1x1 rib, k5, ssk, bind off",
    "k3, yo, k2tog, k4, yo, p1, to end",
    "p2, k2tog, k3, yo, ssk, p2",
    "k1, p1 to end, cast on, bind off"
  ],
  fr: [
    "jeté, 2 m. end. ens., 3 m.env., rabattre",
    "monter, côtes 1x1, 2 m. ens. à l'end., surjet, rabattre",
    "endroit, jeté, 2 m.end. ens., envers jusqu'à la fin",
    "maille envers, 2 m.env. ens., jeté, endroit",
    "monter 10, point mousse, rabattre"
  ]
};

// Session & Debug Log
let currentSessionId = null;
let sessionLog = [];

function generateSessionId() {
  return "SID_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
}

function logEvent(type, data) {
  sessionLog.push({
    timestamp: new Date().toISOString(),
    type: type,
     data
  });
}

function saveSession() {
  const key = "strickSession_" + currentSessionId;
  const session = {
    id: currentSessionId,
    created: new Date().toISOString(),
    log: sessionLog,
    userAgent: navigator.userAgent
  };
  try {
    localStorage.setItem(key, JSON.stringify(session));
  } catch (e) {
    console.warn("localStorage nicht verfügbar");
  }
}

function getTechSupportText() {
  if (!currentSessionId) {
    currentSessionId = generateSessionId();
  }
  const input = document.getElementById('input').value;
  const output = document.getElementById('output').innerText || "(keine Ausgabe)";
  const text = `Hallo Tobi, ich brauche Hilfe beim Strick-Übersetzer.%0A%0ASession-ID: ${currentSessionId}%0AEingabe: ${encodeURIComponent(input)}%0AOutput: ${encodeURIComponent(output)}`;
  return text;
}

// Zitate
const quotes = [
  {
    text: "In der Beschränkung zeigt sich der Meister.",
    author: "Johann Wolfgang von Goethe",
    source: "Wilhelm Meisters Lehrjahre"
  },
  {
    text: "Geduld ist die schwere Kunst, das Tempo der Dinge zu ertragen.",
    author: "Theodor Fontane",
    source: "Briefe"
  },
  {
    text: "Es ist nicht genug zu wissen, man muß auch anwenden; es ist nicht genug zu wollen, man muß auch tun.",
    author: "Johann Wolfgang von Goethe",
    source: "Maximen und Reflexionen"
  },
  {
    text: "Mit dem Kleinen fängt man an, um das Große zu vollenden.",
    author: "Friedrich Schiller",
    source: "Über naive und sentimentalische Dichtung"
  },
  {
    text: "Auch aus Steinen, die einem in den Weg gelegt werden, kann man Schönes bauen.",
    author: "Johann Wolfgang von Goethe",
    source: "Sprüche in Prosa"
  }
];

let usageTimestamps = [];

function shouldShowQuote() {
  const now = Date.now();
  const fiveMin = 5 * 60 * 1000;
  usageTimestamps = usageTimestamps.filter(ts => now - ts <= fiveMin);
  usageTimestamps.push(now);
  return usageTimestamps.length > 3;
}

function renderQuoteBlock() {
  const q = quotes[Math.floor(Math.random() * quotes.length)];
  return `
    <div class="quote-box">
      <div class="quote-text">„${q.text}"</div>
      <div class="quote-author">${q.author}</div>
      <div class="quote-source">Quelle: ${q.source}</div>
    </div>
  `;
}

// Normalise & Match-Funktionen
function normalize(str) {
  return str
    .toLowerCase()
    .replace(/[`´'']/g, "'")
    .replace(/\s+/g, " ")
    .trim();
}

function matchNumericPattern(chunk) {
  const t = normalize(chunk);
  const regex = /(\d+)\s*(li|re|k|p)/g;
  let matches = [];
  let m;
  while ((m = regex.exec(t)) !== null) {
    const count = m[1];
    const code  = m[2];

    let entry;
    if (code === "li" || code === "p") {
      entry = dict.find(e => e.deLong === "linke Masche");
    } else {
      entry = dict.find(e => e.deLong === "rechte Masche");
    }
    if (!entry) continue;

    matches.push({ count, entry, code });
  }
  return matches.length ? matches : null;
}

function matchChunkDirect(chunk) {
  const t = normalize(chunk);

  for (const e of dict) {
    if (
      t.includes(normalize(e.deShort)) || t.includes(normalize(e.deLong)) ||
      t.includes(normalize(e.enShort)) || t.includes(normalize(e.enLong)) ||
      t.includes(normalize(e.frShort)) || t.includes(normalize(e.frLong))
    ) {
      return e;
    }
  }
  return null;
}

function detectLangHint(chunk) {
  const t = normalize(chunk);
  if (/[àâçéèêëîïôùûüÿœ]/.test(t)) return "fr";
  if (t.match(/\b(k|p|yo|ssk|k2tog|p2tog|co|bo)\b/)) return "en";
  if (/[äöüß]/.test(t)) return "de";
  return "unknown";
}

// Verlauf (localStorage)
const HISTORY_KEY = "strickUebersetzerHistoryV1";
let historyEntries = [];

function loadHistory() {
  try {
    const raw = localStorage.getItem(HISTORY_KEY);
    historyEntries = raw ? JSON.parse(raw) : [];
  } catch (e) {
    historyEntries = [];
  }
}

function saveHistory() {
  try {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(historyEntries));
  } catch (e) {
    console.warn("Historie konnte nicht gespeichert werden");
  }
}

function addToHistory(text) {
  const trimmed = text.trim();
  if (!trimmed) return;
  historyEntries.unshift({ text: trimmed, time: Date.now() });
  if (historyEntries.length > 100) historyEntries.pop();
  saveHistory();
  renderHistory();
}

function renderHistory() {
  const ul = document.getElementById('history');
  ul.innerHTML = "";
  if (historyEntries.length === 0) {
    ul.innerHTML = "<p class='history-empty'>Noch keine Einträge.</p>";
    return;
  }
  historyEntries.forEach((entry, idx) => {
    const li = document.createElement("li");
    li.className = "history-item";
    const shortText = entry.text.length > 80 ? entry.text.slice(0, 80) + " …" : entry.text;
    li.innerHTML = `<span>#${historyEntries.length - idx}</span>${shortText}`;
    li.addEventListener("click", () => {
      document.getElementById('input').value = entry.text;
      doTranslate(false, false);
    });
    ul.appendChild(li);
  });
}

// Haupt-Übersetzungsfunktion
function doTranslate(addHistory = true, triggerQuote = true) {
  const raw = document.getElementById('input').value;
  const mainLang = document.getElementById('mainLang').value;
  const showOthers = document.getElementById('showOthers').checked;

  const cleaned = normalize(raw.replace(/[.;:]/g, ","));

  if (!cleaned) {
    document.getElementById('output').innerHTML =
      "Bitte eine Strickanweisung eingeben (Deutsch, Englisch oder Französisch).";
    document.getElementById('quote').innerHTML = "";
    return;
  }

  if (addHistory) addToHistory(raw);
  logEvent("translate", { input: raw, mainLang: mainLang });

  const chunks = cleaned.split(",").map(c => c.trim()).filter(Boolean);
  let anyWarning = false;

  let deShort = [], deLong = [];
  let enShort = [], enLong = [];
  let frShort = [], frLong = [];

  for (const chunk of chunks) {
    const numericMatches = matchNumericPattern(chunk);

    if (numericMatches) {
      numericMatches.forEach(m => {
        const c = m.count;
        const e = m.entry;

        const deS = (e.deShort === "re" || e.deShort === "li")
          ? c + " " + e.deShort
          : e.deShort;
        const deL = c + " " + (c === "1"
          ? e.deLong
          : e.deLong.replace("Masche", "Maschen"));

        const baseCode = m.code === "li" || m.code === "p" ? "p" : "k";
        const enS = baseCode + c;
        const enL = c + " " + e.enLong;

        const frS = c + " " + e.frShort;
        const frL = c + " " + e.frLong;

        deShort.push(deS);
        deLong.push(deL);
        enShort.push(enS);
        enLong.push(enL);
        frShort.push(frS);
        frLong.push(frL);
      });
      continue;
    }

    const entry = matchChunkDirect(chunk);
    if (entry) {
      const hint = detectLangHint(chunk);
      if (hint !== "unknown" && hint !== "de") anyWarning = true;

      deShort.push(entry.deShort);
      deLong.push(entry.deLong);
      enShort.push(entry.enShort);
      enLong.push(entry.enLong);
      frShort.push(entry.frShort);
      frLong.push(entry.frLong);
    } else {
      anyWarning = true;
      deShort.push("[unbekannt: " + chunk + "]");
      enShort.push("[unknown: " + chunk + "]");
      frShort.push("[inconnu: " + chunk + "]");
    }
  }

  function pickLists(lang) {
    if (lang === "de") return { short: deShort, long: deLong };
    if (lang === "en") return { short: enShort, long: enLong };
    return { short: frShort, long: frLong };
  }

  const main = pickLists(mainLang);

  let header = "";
  if (anyWarning) {
    header += "<div class='warning'>Hinweis: Übersetzungsfehler oder Ungenauigkeiten möglich. Bitte Eingabe prüfen.</div>";
  }

  function renderMainSection(label, lists) {
    const sLine = lists.short.length ? lists.short.join(", ") : "-";
    const lLine = lists.long.length  ? lists.long.join(", ")  : "-";

    return `
      <div>
        <div class="section-title">${label} – Kurzformen</div>
        <div>${sLine}</div>
        <div class="section-title" style="margin-top:6px;">${label} – Langformen</div>
        <div>${lLine}</div>
      </div>
    `;
  }

  function shortJoined(list) {
    return list.length ? list.join(", ") : "-";
  }

  let secondaryHtml = "";
  if (showOthers) {
    if (mainLang !== "de") {
      secondaryHtml += `<div class="secondary-row"><span class="secondary-label">Deutsch:</span>${shortJoined(deShort)}</div>`;
    }
    if (mainLang !== "en") {
      secondaryHtml += `<div class="secondary-row"><span class="secondary-label">English:</span>${shortJoined(enShort)}</div>`;
    }
    if (mainLang !== "fr") {
      secondaryHtml += `<div class="secondary-row"><span class="secondary-label">Français:</span>${shortJoined(frShort)}</div>`;
    }
  }

  const mainLabel = mainLang === "de" ? "Deutsch" : mainLang === "en" ? "English" : "Français";

  const html =
    header +
    renderMainSection(mainLabel, main) +
    secondaryHtml;

  document.getElementById('output').innerHTML = html;

  if (triggerQuote && shouldShowQuote()) {
    document.getElementById('quote').innerHTML = renderQuoteBlock();
  } else if (!triggerQuote) {
    document.getElementById('quote').innerHTML = "";
  }

  saveSession();
}

// Zufällige Beispiele (nur EN/FR)
function generateRandomExample() {
  const langs = ["en", "fr"];
  const lang = langs[Math.floor(Math.random() * langs.length)];
  const example = examples[lang][Math.floor(Math.random() * examples[lang].length)];
  
  document.getElementById('input').value = example;
  logEvent("random_example", { lang: lang, example: example });
  doTranslate(true, true);
}

// Dark Mode
const bodyEl = document.body;

function applyDarkMode(on) {
  if (on) {
    document.documentElement.style.setProperty("--bg", "#020617");
    document.documentElement.style.setProperty("--card-bg", "#0f172a");
    document.documentElement.style.setProperty("--text-main", "#e5e7eb");
    document.documentElement.style.setProperty("--text-muted", "#9ca3af");
    document.documentElement.style.setProperty("--border", "#1f2937");
    document.documentElement.style.setProperty("--table-head-bg", "#111827");
    document.documentElement.style.setProperty("--quote-bg", "#111827");
    document.documentElement.style.setProperty("--quote-border", "#1f2937");
    document.documentElement.style.setProperty("--output-bg", "#020617");
    bodyEl.style.background = "var(--bg)";
    const textareas = document.querySelectorAll("textarea");
    textareas.forEach(t => {
      t.style.background = "#020617";
      t.style.color = "#e5e7eb";
      t.style.borderColor = "#1f2937";
    });
  } else {
    document.documentElement.style.setProperty("--bg", "#f5f7fb");
    document.documentElement.style.setProperty("--card-bg", "#ffffff");
    document.documentElement.style.setProperty("--text-main", "#111827");
    document.documentElement.style.setProperty("--text-muted", "#6b7280");
    document.documentElement.style.setProperty("--border", "#e5e7eb");
    document.documentElement.style.setProperty("--table-head-bg", "#eff1ff");
    document.documentElement.style.setProperty("--quote-bg", "#eef2ff");
    document.documentElement.style.setProperty("--quote-border", "#d1d5ff");
    document.documentElement.style.setProperty("--output-bg", "#f9fafb");
    bodyEl.style.background = "var(--bg)";
    const textareas = document.querySelectorAll("textarea");
    textareas.forEach(t => {
      t.style.background = "#ffffff";
      t.style.color = "#111827";
      t.style.borderColor = "var(--border)";
    });
  }
}

function applyFontSize(mode) {
  if (mode === "large") {
    bodyEl.style.fontSize = "110%";
  } else if (mode === "xlarge") {
    bodyEl.style.fontSize = "125%";
  } else {
    bodyEl.style.fontSize = "100%";
  }
}

// Event-Listener
document.getElementById('darkToggle').addEventListener('change', (e) => {
  applyDarkMode(e.target.checked);
});

const fontButtons = document.querySelectorAll(".font-btn");
fontButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    fontButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    applyFontSize(btn.getAttribute("data-size"));
  });
});

const tableToggle = document.getElementById("tableToggle");
const tableContainer = document.getElementById("tableContainer");
const tableToggleIcon = document.getElementById("tableToggleIcon");

tableToggle.addEventListener("click", () => {
  const hidden = tableContainer.classList.contains("hidden");
  if (hidden) {
    tableContainer.classList.remove("hidden");
    tableToggleIcon.textContent = "▼";
  } else {
    tableContainer.classList.add("hidden");
    tableToggleIcon.textContent = "▶";
  }
});

document.getElementById('btn').addEventListener('click', () => doTranslate(true, true));
document.getElementById('btnExample').addEventListener('click', generateRandomExample);

// Tech Support Link
const techSupportLink = document.getElementById('techSupportLink');
techSupportLink.addEventListener('click', (e) => {
  e.preventDefault();
  if (!currentSessionId) {
    currentSessionId = generateSessionId();
  }
  saveSession();
  const supportText = getTechSupportText();
  window.location.href = `sms:+491701234567&body=${supportText}`;
});

// Initial
loadHistory();
renderHistory();

// Session-ID anzeigen (optional, für Debugging)
function updateSessionDisplay() {
  if (!currentSessionId) {
    currentSessionId = generateSessionId();
  }
  const sessionEl = document.getElementById('sessionInfo');
  sessionEl.textContent = `Session-ID: ${currentSessionId}`;
  sessionEl.style.display = 'block';
}

// Beim Start Session-ID erzeugen
currentSessionId = generateSessionId();
updateSessionDisplay();
</script>
</body>
</html>
